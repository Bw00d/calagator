<%
# Arguments:
# * events => Array of Event records

opts ||= {}
previous_start_time = nil
show_year ||= false
skipped = 0
%>

<% 
counter = 1
rowspans = Array.new(events.size, 0)

events.each_with_index do |event, index|
	new_day = previous_start_time.nil? || previous_start_time && previous_start_time.to_date != event.start_time.to_date

	if new_day
		rowspans[index-counter] = counter
		counter = 1
	else
		counter += 1
	end
	previous_start_time = event.start_time
end 
%>
<table class='event_table'>
	<thead>
		<tr>
			<th class='date'>Sort By: <%= link_to "Date", url_for(params.merge(:order => 'date')) %></th>
			<th class='event_summary'><%= link_to "Event Name", url_for(params.merge(:order => 'name')) %>, <%= link_to "Location", url_for(params.merge(:order => 'venue')) %></th>
		</tr>
	</thead>
	<tbody>
		<% unless events.size==0 %>
			<% events.each_with_index do |event, index| %>
				<% new_day = previous_start_time.nil? || previous_start_time && previous_start_time.to_date != event.start_time.to_date %>
				<tr class='vevent'>
					<% if rowspans[index] > 0 %>
					<td class='date' rowspan="<%=rowspans[index]%>">
						<div class='day_of_week <%= today_tomorrow_or_weekday(event).downcase -%>'>
							<%= today_tomorrow_or_weekday(event) %>
						</div>
						<%= datetime_format(event.start_time,'%b %d') -%><%= ", "+datetime_format(event.start_time,'%Y') if show_year %>
					</td>
					<% end %>
					<td class='event_summary'>
						<a class='summary' href='<%= url_for event_url(event) %>'><%= h event.title %></a><br />
						<%= normalize_time(event, :context => event.start_time.to_date) -%>
						<% if event.venue && !event.venue.title.blank? %>
				      <a class='location' href='<%= url_for venue_url(event.venue) %>'><%= h event.venue.title -%></a>
				    <% end -%>
				
						<% if !event.description.blank? %>
				      <div class='description'>
				        <%= upgrade_br(auto_link(white_list(event.description))) -%>
				      </div>
				    <% end -%>
				    <% if !event.url.blank? -%>
				      <%= link_to "Website", event.url, :class => "url" -%>
				    <% end -%>
					</td>
				</tr>
				<% previous_start_time = event.start_time %>
			<% end %>
		<% else %>		
			<tr>
				<td colspan=2>No events were found.</td>
			</tr>
		<% end %>
		<% if skipped > 0 %>
	    <tr>
				<td colspan=2>
		      <%= link_to "(And #{skipped} more)", events_url %>
				</td>
	    </tr>
		<% end %>
	</tbody>
</table>
